<!DOCTYPE html>
<html>
<head>
    <title>Oscar Predictions - Admin Panel</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <link href="./sources/frontend/fonts/veteran_typewriter.css" rel="stylesheet" type="text/css">
    <link rel="shortcut icon" href="./sources/frontend/tm.ico">
    <meta name="viewport" content="width=device-width, initial-scale=0.6">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <style>
        .gold-border { border: 2px solid #d4af37 !important; }
        .gold-text { color: #d4af37 !important; }
        .winner-highlight { background: linear-gradient(145deg, #d4af37 0%, #b8960c 100%) !important; color: #1a1a1a !important; }
    </style>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.24.0/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-scrollto"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js"></script>
    <div id="app">
        <v-app dark>
            <v-app-bar app color="#1a1a1a">
                <v-avatar
                    size="30"
                    :color="websocketConnected ? 'success' : 'error'"
                >
                    <v-icon v-if="websocketConnected">mdi-check</v-icon>
                    <v-icon v-else>mdi-close</v-icon>
                </v-avatar>
                <v-spacer></v-spacer>
                <v-icon color="#d4af37" class="mr-2">mdi-trophy</v-icon>
                <h3 class="font-weight-regular gold-text">
                    Oscar Predictions Admin
                </h3>
                <v-spacer></v-spacer>
                <v-switch
                    v-model="darkMode"
                    dense
                    hide-details
                >
                    <template v-slot:label>
                        <v-icon>mdi-moon-waxing-crescent</v-icon>
                    </template>
                </v-switch>
                <template v-slot:extension>
                    <v-tabs centered grow>
                        <v-tab @click="$vuetify.goTo($refs.controls, scrollOptions)">
                            Controls
                        </v-tab>
                        <v-tab @click="$vuetify.goTo($refs.rooms, scrollOptions)">
                            Rooms
                        </v-tab>
                        <v-tab @click="$vuetify.goTo($refs.awards, scrollOptions)">
                            Awards
                        </v-tab>
                        <v-tab @click="$vuetify.goTo($refs.guests, scrollOptions)">
                            Guests
                        </v-tab>
                    </v-tabs>
                </template>
            </v-app-bar>

            <v-main>
                <!-- Basic Controls -->
                <v-container fluid ref="controls">
                    <h3 class="font-weight-regular gold-text mb-3">
                        <v-icon color="#d4af37" class="mr-2">mdi-cog</v-icon>
                        Display Controls
                    </h3>
                    <v-row>
                        <v-col cols="12" md="6">
                            <v-card class="pa-3" outlined>
                                <v-card-subtitle>Screen Display</v-card-subtitle>
                                <v-btn class="ma-1" color="primary" @click="sendMessage('showScoreboard')">
                                    <v-icon left>mdi-view-list</v-icon>
                                    Show Scoreboard
                                </v-btn>
                                <v-btn class="ma-1" color="primary" @click="sendMessage('showTaskmaster')">
                                    <v-icon left>mdi-home</v-icon>
                                    Show Logo
                                </v-btn>
                            </v-card>
                        </v-col>
                        <v-col cols="12" md="6">
                            <v-card class="pa-3" outlined>
                                <v-card-subtitle>Prediction Lock</v-card-subtitle>
                                <v-switch
                                    v-model="predictionsLocked"
                                    :label="predictionsLocked ? 'Predictions LOCKED' : 'Predictions OPEN'"
                                    :color="predictionsLocked ? 'error' : 'success'"
                                    @change="togglePredictionsLock"
                                    inset
                                ></v-switch>
                                <v-chip
                                    :color="predictionsLocked ? 'error' : 'success'"
                                    class="mt-2"
                                >
                                    <v-icon left small>{{ predictionsLocked ? 'mdi-lock' : 'mdi-lock-open' }}</v-icon>
                                    {{ guests.length }} guests registered
                                </v-chip>
                            </v-card>
                        </v-col>
                    </v-row>
                </v-container>

                <v-divider class="my-4"></v-divider>

                <!-- Rooms Section -->
                <v-container fluid ref="rooms">
                    <h3 class="font-weight-regular gold-text mb-3">
                        <v-icon color="#d4af37" class="mr-2">mdi-door</v-icon>
                        Room Management
                    </h3>

                    <v-row>
                        <v-col cols="12" md="6">
                            <v-card class="pa-3" outlined>
                                <v-card-subtitle>Create New Room</v-card-subtitle>
                                <v-text-field
                                    v-model="newRoomName"
                                    label="Room Name"
                                    outlined
                                    dense
                                    placeholder="e.g., Family"
                                ></v-text-field>
                                <v-text-field
                                    v-model="newRoomCode"
                                    label="Room Code"
                                    outlined
                                    dense
                                    placeholder="e.g., family"
                                    hint="Lowercase, no spaces - used in URLs"
                                ></v-text-field>
                                <v-btn
                                    color="primary"
                                    @click="createRoom"
                                    :disabled="!newRoomName || !newRoomCode"
                                >
                                    <v-icon left>mdi-plus</v-icon>
                                    Create Room
                                </v-btn>
                            </v-card>
                        </v-col>
                        <v-col cols="12" md="6">
                            <v-card class="pa-3" outlined>
                                <v-card-subtitle>Existing Rooms</v-card-subtitle>
                                <v-list dense v-if="rooms.length > 0">
                                    <v-list-item
                                        v-for="room in rooms"
                                        :key="room.id"
                                    >
                                        <v-list-item-content>
                                            <v-list-item-title>{{ room.name }}</v-list-item-title>
                                            <v-list-item-subtitle>Code: {{ room.code }}</v-list-item-subtitle>
                                        </v-list-item-content>
                                        <v-list-item-action>
                                            <v-btn icon small color="error" @click="deleteRoom(room.id)">
                                                <v-icon small>mdi-delete</v-icon>
                                            </v-btn>
                                        </v-list-item-action>
                                    </v-list-item>
                                </v-list>
                                <div v-else class="text-center grey--text pa-4">
                                    No rooms created yet
                                </div>
                            </v-card>
                        </v-col>
                    </v-row>
                </v-container>

                <v-divider class="my-4"></v-divider>

                <!-- Awards Section -->
                <v-container fluid ref="awards">
                    <h3 class="font-weight-regular gold-text mb-3">
                        <v-icon color="#d4af37" class="mr-2">mdi-trophy</v-icon>
                        Award Presentation
                    </h3>

                    <v-select
                        v-model="selectedAwardId"
                        :items="awardOptions"
                        item-text="name"
                        item-value="id"
                        label="Select Award to Present"
                        outlined
                        dense
                        class="mb-4"
                        @change="showAwardOnScreen"
                    >
                        <template v-slot:item="{ item }">
                            <v-icon left :color="winners[item.id] ? '#d4af37' : 'grey'">
                                {{ winners[item.id] ? 'mdi-trophy' : 'mdi-trophy-outline' }}
                            </v-icon>
                            {{ item.name }}
                            <v-chip v-if="winners[item.id]" x-small class="ml-2" color="success">Winner Set</v-chip>
                        </template>
                    </v-select>

                    <v-card v-if="selectedAward" outlined class="gold-border">
                        <v-card-title class="gold-text">
                            <v-icon left color="#d4af37">mdi-trophy</v-icon>
                            {{ selectedAward.name }}
                        </v-card-title>
                        <v-card-subtitle>
                            Click a nominee to select them as the winner
                        </v-card-subtitle>
                        <v-card-text>
                            <v-row>
                                <v-col
                                    v-for="nominee in selectedAward.nominees"
                                    :key="nominee.id"
                                    cols="12"
                                    sm="6"
                                    md="4"
                                >
                                    <v-card
                                        :class="{ 'winner-highlight': winners[selectedAward.id] === nominee.id }"
                                        @click="selectWinner(selectedAward.id, nominee.id)"
                                        outlined
                                        hover
                                        style="cursor: pointer;"
                                    >
                                        <v-card-text class="text-center">
                                            <v-icon
                                                v-if="winners[selectedAward.id] === nominee.id"
                                                color="#1a1a1a"
                                                large
                                            >
                                                mdi-trophy
                                            </v-icon>
                                            <div :class="{ 'black--text': winners[selectedAward.id] === nominee.id }">
                                                {{ nominee.name }}
                                            </div>
                                        </v-card-text>
                                    </v-card>
                                </v-col>
                            </v-row>
                        </v-card-text>
                        <v-card-actions>
                            <v-btn
                                v-if="winners[selectedAward.id]"
                                text
                                color="error"
                                @click="clearWinner(selectedAward.id)"
                            >
                                <v-icon left>mdi-close</v-icon>
                                Clear Winner
                            </v-btn>
                        </v-card-actions>
                    </v-card>

                    <!-- Winners Summary -->
                    <v-card class="mt-4" outlined>
                        <v-card-title>
                            <v-icon left color="#d4af37">mdi-format-list-checks</v-icon>
                            Winners Summary ({{ Object.keys(winners).length }} / {{ awards.length }})
                        </v-card-title>
                        <v-card-text>
                            <v-chip
                                v-for="award in awards"
                                :key="award.id"
                                :color="winners[award.id] ? 'success' : 'grey'"
                                class="ma-1"
                                small
                            >
                                {{ award.name }}
                                <v-icon v-if="winners[award.id]" right small>mdi-check</v-icon>
                            </v-chip>
                        </v-card-text>
                    </v-card>
                </v-container>

                <v-divider class="my-4"></v-divider>

                <!-- Guests Section -->
                <v-container fluid ref="guests">
                    <h3 class="font-weight-regular gold-text mb-3">
                        <v-icon color="#d4af37" class="mr-2">mdi-account-group</v-icon>
                        Guests & Scores
                    </h3>

                    <v-row class="mb-4">
                        <v-col cols="12" md="6">
                            <v-card class="pa-3" outlined>
                                <v-card-subtitle>Add New Guest</v-card-subtitle>
                                <v-text-field
                                    v-model="newGuestName"
                                    label="Guest Name"
                                    outlined
                                    dense
                                    placeholder="e.g., John Smith"
                                ></v-text-field>
                                <div class="mb-2">Assign to rooms:</div>
                                <v-chip-group
                                    v-model="newGuestRooms"
                                    multiple
                                    column
                                >
                                    <v-chip
                                        v-for="room in rooms"
                                        :key="room.code"
                                        :value="room.code"
                                        filter
                                        outlined
                                    >
                                        {{ room.name }}
                                    </v-chip>
                                </v-chip-group>
                                <v-btn
                                    color="primary"
                                    @click="createGuest"
                                    :disabled="!newGuestName"
                                    class="mt-2"
                                >
                                    <v-icon left>mdi-account-plus</v-icon>
                                    Add Guest
                                </v-btn>
                            </v-card>
                        </v-col>
                        <v-col cols="12" md="6">
                            <v-card class="pa-3" outlined>
                                <v-card-subtitle>Guest Management</v-card-subtitle>
                                <v-btn
                                    color="primary"
                                    class="ma-1"
                                    @click="loadGuests"
                                >
                                    <v-icon left>mdi-refresh</v-icon>
                                    Refresh Guests
                                </v-btn>
                                <div class="mt-3">
                                    <v-chip color="info" class="mr-2">
                                        {{ guests.length }} guests registered
                                    </v-chip>
                                </div>
                            </v-card>
                        </v-col>
                    </v-row>

                    <v-simple-table fixed-header height="400">
                        <template v-slot:default>
                            <thead>
                                <tr>
                                    <th class="text-left">Guest</th>
                                    <th class="text-left">Rooms</th>
                                    <th class="text-center">Score</th>
                                    <th
                                        v-for="award in awards"
                                        :key="award.id"
                                        class="text-center"
                                        style="min-width: 120px;"
                                    >
                                        {{ award.name.replace('Best ', '') }}
                                    </th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="guest in sortedGuests" :key="guest.id">
                                    <td>
                                        <v-avatar v-if="guest.photo" size="30" class="mr-2">
                                            <v-img :src="'/home/data/' + guest.photo"></v-img>
                                        </v-avatar>
                                        {{ guest.name }}
                                    </td>
                                    <td>
                                        <v-chip
                                            v-for="roomCode in (guest.rooms || [])"
                                            :key="roomCode"
                                            x-small
                                            class="mr-1"
                                        >
                                            {{ getRoomName(roomCode) }}
                                        </v-chip>
                                        <v-btn
                                            icon
                                            x-small
                                            @click="openEditRoomsDialog(guest)"
                                        >
                                            <v-icon x-small>mdi-pencil</v-icon>
                                        </v-btn>
                                    </td>
                                    <td class="text-center">
                                        <v-chip
                                            color="#d4af37"
                                            text-color="black"
                                            small
                                        >
                                            {{ guest.score || 0 }}
                                        </v-chip>
                                    </td>
                                    <td
                                        v-for="award in awards"
                                        :key="award.id"
                                        class="text-center"
                                    >
                                        <v-chip
                                            :color="getPredictionColor(guest, award.id)"
                                            x-small
                                        >
                                            {{ getNomineeName(award.id, guest.predictions[award.id]) }}
                                        </v-chip>
                                    </td>
                                    <td class="text-center">
                                        <v-btn
                                            icon
                                            small
                                            color="error"
                                            @click="deleteGuest(guest.id)"
                                        >
                                            <v-icon small>mdi-delete</v-icon>
                                        </v-btn>
                                    </td>
                                </tr>
                            </tbody>
                        </template>
                    </v-simple-table>

                    <!-- Edit Guest Rooms Dialog -->
                    <v-dialog v-model="editRoomsDialog" width="500">
                        <v-card>
                            <v-card-title>
                                <v-icon left color="#d4af37">mdi-door</v-icon>
                                Edit Rooms for {{ editingGuest ? editingGuest.name : '' }}
                            </v-card-title>
                            <v-card-text>
                                <div class="mb-2">Select which rooms this guest belongs to:</div>
                                <v-chip-group
                                    v-model="editingGuestRooms"
                                    multiple
                                    column
                                >
                                    <v-chip
                                        v-for="room in rooms"
                                        :key="room.code"
                                        :value="room.code"
                                        filter
                                        outlined
                                    >
                                        {{ room.name }}
                                    </v-chip>
                                </v-chip-group>
                                <div v-if="rooms.length === 0" class="grey--text">
                                    No rooms have been created yet. Create rooms in the Rooms tab first.
                                </div>
                            </v-card-text>
                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn text @click="editRoomsDialog = false">Cancel</v-btn>
                                <v-btn color="primary" @click="saveGuestRooms">Save</v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-dialog>

                    <!-- Delete All Guests -->
                    <v-dialog v-model="deleteDialog" width="400">
                        <template v-slot:activator="{ on, attrs }">
                            <v-btn
                                color="error"
                                class="mt-4"
                                v-bind="attrs"
                                v-on="on"
                                small
                            >
                                <v-icon left>mdi-delete</v-icon>
                                Clear All Guests
                            </v-btn>
                        </template>
                        <v-card>
                            <v-card-title>Clear All Guests?</v-card-title>
                            <v-card-text>
                                This will permanently delete all guest data and predictions.
                            </v-card-text>
                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn text @click="deleteDialog = false">Cancel</v-btn>
                                <v-btn color="error" @click="clearAllGuests">Delete All</v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-dialog>
                </v-container>
            </v-main>
        </v-app>
    </div>
    <script src="./sources/frontend/js/reconnecting-websocket.min.js"></script>
    <script src="./sources/frontend/js/assistant.js"></script>
</body>
</html>
